# File Service

Универсальный файловый сервис с поддержкой S3 и локального хранилища.

## Описание

Этот сервис предоставляет единый API для работы с файлами, автоматически выбирая между S3 и локальным хранилищем в зависимости от доступности.

## Возможности

- ✅ Автоматический выбор между S3 и локальным хранилищем
- ✅ Проверка доступности S3 при старте
- ✅ Фолбэк на локальное хранилище при недоступности S3
- ✅ Универсальный API для работы с файлами
- ✅ Безопасная аутентификация через API ключ (защита от timing attacks)
- ✅ Поддержка различных типов файлов
- ✅ Автоматическое создание папок для хранения
- ✅ Потоковая передача файлов (streaming) для эффективной работы с большими файлами
- ✅ Компрессия ответов (gzip/brotli)
- ✅ Rate limiting для защиты от злоупотреблений
- ✅ Graceful shutdown для корректного завершения работы
- ✅ Валидация файлов по содержимому (magic numbers)
- ✅ Защита от path traversal атак

## Установка

```bash
npm install
```

## Конфигурация

Скопируйте `.env.example` в `.env` и настройте переменные окружения. Все доступные переменные и их описание находятся в файле `.env.example`.

## Запуск

### Development

```bash
npm run dev
```

### Production

```bash
npm run build
npm start
```

## API

### Загрузка файла

```http
POST /api/upload
X-API-Key: your-api-key
Content-Type: multipart/form-data

file: [binary]
folder: products
prefix: product
```

**Ответ:**
```json
{
  "success": true,
  "filename": "product-1234567890-987654321.jpg",
  "url": "https://...",
  "path": "/files/products/product-1234567890-987654321.jpg",
  "size": 102400
}
```

### Удаление файла

```http
DELETE /api/delete
X-API-Key: your-api-key
Content-Type: application/json

{
  "path": "/files/products/product-123.jpg"
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "File deleted successfully"
}
```

### Проверка существования файла

```http
GET /api/exists?path=/files/products/product-123.jpg
X-API-Key: your-api-key
```

**Ответ:**
```json
{
  "exists": true
}
```

### Получение файла

```http
GET /files/products/product-123.jpg
```

Публичный endpoint, не требует API ключ. Файлы отдаются через потоковую передачу.

### Статус сервиса

```http
GET /api/status
X-API-Key: your-api-key
```

**Ответ:**
```json
{
  "available": true,
  "storageType": "s3",
  "timestamp": "2025-01-27T12:00:00.000Z"
}
```

### Health Check

```http
GET /health
```

Публичный endpoint для проверки работоспособности сервиса.

## Логика работы

1. При старте сервис проверяет доступность S3
2. Если S3 доступен и настроен - используется S3
3. Если S3 недоступен - используется локальное хранилище
4. Все операции выполняются через единый интерфейс
5. Файлы передаются через потоковую передачу для эффективной работы с большими файлами

## Безопасность

- **Аутентификация**: Все административные операции требуют API ключ в заголовке `X-API-Key`
- **Защита от timing attacks**: Используется безопасное сравнение ключей через `crypto.timingSafeEqual()`
- **Path traversal защита**: Все пути нормализуются и валидируются перед использованием
- **Валидация файлов**: Проверка расширения, MIME типа и содержимого файла (magic numbers)
- **Rate limiting**: Ограничение количества запросов с одного IP адреса
- **HTTPS enforcement**: Возможность принудительного использования HTTPS в production
- **CORS**: Настраиваемая политика CORS для контроля доступа

